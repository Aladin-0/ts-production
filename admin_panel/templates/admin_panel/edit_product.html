{% extends 'admin_panel/base.html' %}

{% block title %}Edit Product - TechVerse Admin{% endblock %}

{% block page_title %}Edit Product: {{ product.name }}{% endblock %}

{% block top_actions %}
<a href="{% url 'admin_panel:products' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i>
    Back to Products
</a>
<a href="/product/{{ product.slug }}/" target="_blank" class="btn btn-secondary">
    <i class="fas fa-external-link-alt"></i>
    View Product
</a>
<button form="productForm" type="submit" class="btn btn-primary">
    <i class="fas fa-save"></i>
    Update Product
</button>
{% endblock %}

{% block content %}
<form id="productForm" method="post" enctype="multipart/form-data" style="max-width: 1200px;">
    {% csrf_token %}
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        <!-- Main Product Information -->
        <div>
            <!-- Basic Information -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Basic Information</h3>
                    <div style="display: flex; gap: 10px;">
                        <span class="status-badge {% if product.is_active %}status-completed{% else %}status-cancelled{% endif %}">
                            {% if product.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                        {% if product.is_featured %}
                        <span class="status-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">
                            Featured
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Product Name *</label>
                            <input type="text" name="name" class="form-control" value="{{ product.name }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Brand</label>
                            <input type="text" name="brand" class="form-control" value="{{ product.brand }}">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select name="category" class="form-control" required>
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if category.id == product.category.id %}selected{% endif %}>{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Model Number</label>
                            <input type="text" name="model_number" class="form-control" value="{{ product.model_number }}">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Slug</label>
                        <input type="text" name="slug" class="form-control" value="{{ product.slug }}" readonly>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            URL: /product/{{ product.slug }}/
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Product Description *</label>
                        <textarea name="description" class="form-control" rows="4" required>{{ product.description }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Pricing & Inventory -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Pricing & Inventory</h3>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.6);">
                        Created: {{ product.created_at|date:"M d, Y" }}
                    </div>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Price (₹) *</label>
                            <input type="number" name="price" class="form-control" value="{{ product.price }}" step="0.01" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Stock Quantity *</label>
                            <input type="number" name="stock" class="form-control" value="{{ product.stock }}" min="0" required>
                            {% if product.stock < 5 %}
                            <div style="font-size: 12px; color: #ef4444; margin-top: 5px;">
                                <i class="fas fa-exclamation-triangle"></i> Low stock warning
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Weight (kg)</label>
                            <input type="number" name="weight" class="form-control" value="{{ product.weight }}" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div class="form-group">
                            <label class="form-label">Dimensions (L x W x H cm)</label>
                            <input type="text" name="dimensions" class="form-control" value="{{ product.dimensions }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Delivery Time</label>
                            <input type="text" name="delivery_time_info" class="form-control" value="{{ product.delivery_time_info }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Features -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Features & Specifications</h3>
                </div>
                <div style="padding: 30px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Key Features</label>
                        <textarea name="features" class="form-control" rows="3">{{ product.features }}</textarea>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            Separate each feature with a comma
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 30px;">
                        <label class="form-label">Warranty Period</label>
                        <select name="warranty_period" class="form-control">
                            <option value="6 Months" {% if product.warranty_period == "6 Months" %}selected{% endif %}>6 Months</option>
                            <option value="1 Year" {% if product.warranty_period == "1 Year" %}selected{% endif %}>1 Year</option>
                            <option value="2 Years" {% if product.warranty_period == "2 Years" %}selected{% endif %}>2 Years</option>
                            <option value="3 Years" {% if product.warranty_period == "3 Years" %}selected{% endif %}>3 Years</option>
                            <option value="5 Years" {% if product.warranty_period == "5 Years" %}selected{% endif %}>5 Years</option>
                        </select>
                    </div>
                    
                    <!-- Existing Specifications -->
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <label class="form-label" style="margin: 0;">Technical Specifications</label>
                            <button type="button" onclick="addSpecification()" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-plus"></i>
                                Add Specification
                            </button>
                        </div>
                        
                        <div id="specificationsContainer">
                            {% for spec in product.specifications.all %}
                            <div class="specification-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 15px;">
                                <input type="text" name="spec_names[]" class="form-control" value="{{ spec.name }}">
                                <input type="text" name="spec_values[]" class="form-control" value="{{ spec.value }}">
                                <button type="button" onclick="removeSpecification(this)" class="btn btn-danger" style="padding: 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="specification-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 15px;">
                                <input type="text" name="spec_names[]" class="form-control" placeholder="Specification name">
                                <input type="text" name="spec_values[]" class="form-control" placeholder="Specification value">
                                <button type="button" onclick="removeSpecification(this)" class="btn btn-danger" style="padding: 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div>
            <!-- Current Product Images -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Product Images</h3>
                </div>
                <div style="padding: 30px;">
                    <!-- Main Image -->
                    <div class="form-group" style="margin-bottom: 30px;">
                        <label class="form-label">Main Product Image</label>
                        {% if product.image %}
                        <div style="margin-bottom: 15px;">
                            <img src="{{ product.image.url }}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" onclick="changeMainImage()" class="btn btn-secondary" style="flex: 1;">
                                    <i class="fas fa-camera"></i>
                                    Change
                                </button>
                                <button type="button" onclick="removeCurrentMainImage()" class="btn btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div style="display: none;" id="mainImageUpload">
                            <div style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; padding: 20px; text-align: center;">
                                <input type="file" name="new_main_image" id="newMainImage" accept="image/*" style="display: none;">
                                <button type="button" onclick="document.getElementById('newMainImage').click()" class="btn btn-primary">
                                    <i class="fas fa-upload"></i>
                                    Upload New Image
                                </button>
                            </div>
                            <div id="newMainImagePreview" style="margin-top: 15px; display: none;">
                                <img id="newMainImageImg" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Images -->
                    <div class="form-group">
                        <label class="form-label">Additional Images</label>
                        {% if product.additional_images.all %}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;" id="existingImages">
                            {% for image in product.additional_images.all %}
                            <div class="existing-image" data-image-id="{{ image.id }}">
                                <img src="{{ image.image.url }}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px;">
                                <button type="button" onclick="removeExistingImage({{ image.id }})" class="btn btn-danger" style="margin-top: 5px; width: 100%; padding: 2px; font-size: 10px;">
                                    Remove
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; padding: 15px; text-align: center;">
                            <input type="file" name="new_additional_images" id="newAdditionalImages" accept="image/*" multiple style="display: none;">
                            <button type="button" onclick="document.getElementById('newAdditionalImages').click()" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-plus"></i>
                                Add More Images (Up to 10)
                            </button>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                                You can select up to 10 images at once
                            </div>
                        </div>
                        <div id="newAdditionalImagesPreview" style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <!-- New additional image previews will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Settings -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Product Settings</h3>
                </div>
                <div style="padding: 30px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="is_active" value="true" {% if product.is_active %}checked{% endif %} style="width: 18px; height: 18px;">
                            <span>Product is active</span>
                        </label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            Active products are visible to customers
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="is_featured" value="true" {% if product.is_featured %}checked{% endif %} style="width: 18px; height: 18px;">
                            <span>Featured product</span>
                        </label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            Featured products appear in special sections
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">SEO Meta Description</label>
                        <textarea name="meta_description" class="form-control" rows="3" maxlength="160">{{ product.meta_description }}</textarea>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            <span id="metaCharCount">{{ product.meta_description|length }}</span>/160 characters
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Statistics -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Product Statistics</h3>
                </div>
                <div style="padding: 20px;">
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total Orders</span>
                            <strong>0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total Revenue</span>
                            <strong>₹0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Avg. Rating</span>
                            <strong>-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Views</span>
                            <strong>0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Last Updated</span>
                            <strong>{{ product.updated_at|date:"M d" }}</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">Quick Actions</h3>
                </div>
                <div style="padding: 20px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-save"></i>
                        Update Product
                    </button>
                    
                    <button type="button" onclick="duplicateProduct()" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-copy"></i>
                        Duplicate Product
                    </button>
                    
                    <button type="button" onclick="deleteProduct()" class="btn btn-danger" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-trash"></i>
                        Delete Product
                    </button>
                    
                    <a href="{% url 'admin_panel:products' %}" class="btn btn-secondary" style="width: 100%; text-align: center; display: block; text-decoration: none;">
                        <i class="fas fa-arrow-left"></i>
                        Back to Products
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Meta description character count
    document.querySelector('textarea[name="meta_description"]').addEventListener('input', function() {
        document.getElementById('metaCharCount').textContent = this.value.length;
    });

    // Image management
    function changeMainImage() {
        document.getElementById('mainImageUpload').style.display = 'block';
    }

    function removeCurrentMainImage() {
        if (confirm('Are you sure you want to remove the main image?')) {
            // Implementation for removing current main image
            console.log('Remove current main image');
        }
    }

    document.getElementById('newMainImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('newMainImageImg').src = e.target.result;
                document.getElementById('newMainImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Enhanced additional images handling - up to 10 images
    document.getElementById('newAdditionalImages').addEventListener('change', function(e) {
        const container = document.getElementById('newAdditionalImagesPreview');
        container.innerHTML = '';
        
        const files = Array.from(e.target.files);
        
        // Limit to 10 images
        if (files.length > 10) {
            alert('You can only select up to 10 images at once. Only the first 10 will be processed.');
            files.splice(10);
        }
        
        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <img src="${e.target.result}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px;">
                    <button type="button" onclick="removeNewAdditionalImage(this)" class="btn btn-danger" style="margin-top: 5px; width: 100%; padding: 2px; font-size: 10px;">
                        Remove
                    </button>
                `;
                container.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
        
        // Show count of selected images
        if (files.length > 0) {
            const countDiv = document.createElement('div');
            countDiv.style.cssText = 'text-align: center; margin-top: 10px; font-size: 12px; color: #10b981;';
            countDiv.textContent = `${files.length} image${files.length > 1 ? 's' : ''} selected`;
            container.appendChild(countDiv);
        }
    });

    function removeExistingImage(imageId) {
        if (confirm('Are you sure you want to remove this image?')) {
            document.querySelector(`[data-image-id="${imageId}"]`).remove();
            // Add hidden input to track removed images
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'removed_images[]';
            input.value = imageId;
            document.getElementById('productForm').appendChild(input);
        }
    }

    function removeNewAdditionalImage(button) {
        button.parentElement.remove();
        
        // Update the file input to reflect the removal
        const container = document.getElementById('newAdditionalImagesPreview');
        const remainingImages = container.querySelectorAll('img').length;
        
        if (remainingImages === 0) {
            document.getElementById('newAdditionalImages').value = '';
        }
    }

    // Specifications management
    function addSpecification() {
        const container = document.getElementById('specificationsContainer');
        const div = document.createElement('div');
        div.className = 'specification-row';
        div.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 15px;';
        div.innerHTML = `
            <input type="text" name="spec_names[]" class="form-control" placeholder="Specification name">
            <input type="text" name="spec_values[]" class="form-control" placeholder="Specification value">
            <button type="button" onclick="removeSpecification(this)" class="btn btn-danger" style="padding: 10px;">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(div);
    }

    function removeSpecification(button) {
        button.closest('.specification-row').remove();
    }

    // Quick actions
    function duplicateProduct() {
        if (confirm('Create a duplicate of this product?')) {
            alert('Product duplicated successfully! Redirecting to edit the new product...');
            // Implementation for duplicating product
        }
    }

    function deleteProduct() {
        if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
            if (confirm('This will permanently delete the product and all its data. Continue?')) {
                // Implementation for deleting product
                alert('Product deleted successfully!');
                window.location.href = '{% url "admin_panel:products" %}';
            }
        }
    }

    // Form submission
    document.getElementById('productForm').addEventListener('submit', function(e) {
        // Don't prevent default - let form submit normally to Django view
        
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.disabled = true;
        
        // Form will submit normally to Django view
    });

    // Drag and drop for images
    ['mainImageUpload', 'newAdditionalImages'].forEach(id => {
        const element = document.getElementById(id === 'mainImageUpload' ? 'mainImageUpload' : 'newAdditionalImages').parentElement;
        
        element.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'rgba(255,255,255,0.05)';
        });
        
        element.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'transparent';
        });
        
        element.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                if (id === 'mainImageUpload') {
                    document.getElementById('newMainImage').files = files;
                    document.getElementById('newMainImage').dispatchEvent(new Event('change'));
                } else {
                    // For additional images, limit to 10
                    const limitedFiles = Array.from(files).slice(0, 10);
                    const dt = new DataTransfer();
                    limitedFiles.forEach(file => dt.items.add(file));
                    document.getElementById('newAdditionalImages').files = dt.files;
                    document.getElementById('newAdditionalImages').dispatchEvent(new Event('change'));
                }
            }
        });
    });
</script>
{% endblock %}