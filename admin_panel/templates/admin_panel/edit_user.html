{% extends 'admin_panel/base.html' %}

{% block title %}Edit User - TechVerse Admin{% endblock %}

{% block page_title %}Edit User: {{ user_obj.name }}{% endblock %}

{% block top_actions %}
<a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i>
    Back to Users
</a>
<button form="userForm" type="submit" class="btn btn-primary">
    <i class="fas fa-save"></i>
    Update User
</button>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
    <!-- Main Form -->
    <div>
        <form id="userForm" method="post">
            {% csrf_token %}
            
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">User Information</h3>
                    <div style="display: flex; gap: 10px;">
                        <span class="status-badge {% if user_obj.is_active %}status-completed{% else %}status-cancelled{% endif %}">
                            {% if user_obj.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                        <span class="status-badge status-processing">{{ user_obj.get_role_display }}</span>
                    </div>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" name="name" class="form-control" value="{{ user_obj.name }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" name="email" class="form-control" value="{{ user_obj.email }}" required>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" name="phone" class="form-control" value="{{ user_obj.phone|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Role *</label>
                            <select name="role" id="userRole" class="form-control" required>
                                <option value="CUSTOMER" {% if user_obj.role == 'CUSTOMER' %}selected{% endif %}>Customer</option>
                                <option value="TECHNICIAN" {% if user_obj.role == 'TECHNICIAN' %}selected{% endif %}>Technician</option>
                                <option value="AMC" {% if user_obj.role == 'AMC' %}selected{% endif %}>AMC Customer</option>
                                {% if user.is_superuser %}
                                <option value="ADMIN" {% if user_obj.role == 'ADMIN' %}selected{% endif %}>Admin</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Account Settings</h3>
                </div>
                <div style="padding: 30px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="is_active" {% if user_obj.is_active %}checked{% endif %} style="width: 18px; height: 18px;">
                                <span>Account Active</span>
                            </label>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                                Active users can log in and use the system
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="email_notifications" {% if user_obj.email_notifications %}checked{% endif %} style="width: 18px; height: 18px;">
                                <span>Email Notifications</span>
                            </label>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                                User will receive order updates and service notifications via email
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="sms_notifications" {% if user_obj.sms_notifications %}checked{% endif %} style="width: 18px; height: 18px;">
                                <span>SMS Notifications</span>
                            </label>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                                User will receive important updates via SMS
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FREE SERVICE CATEGORIES SECTION - NEW -->
            <div class="table-container" id="amcServicesSection" style="margin-bottom: 30px; {% if user_obj.role != 'AMC' %}display: none;{% endif %}">
                <div class="table-header">
                    <h3 class="table-title">
                        <i class="fas fa-gift"></i>
                        Free Service Categories
                    </h3>
                    <span style="font-size: 12px; color: rgba(255,255,255,0.6); font-weight: 400;">
                        AMC Benefits
                    </span>
                </div>
                <div style="padding: 30px;">
                    <div style="background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; padding: 12px 15px; border-radius: 6px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-info-circle" style="color: #10b981;"></i>
                            <span style="font-size: 13px; color: rgba(255,255,255,0.8);">
                                Select service categories that will be completely free for this AMC customer. They will not be charged for these services.
                            </span>
                        </div>
                    </div>

                    {% if service_categories %}
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        {% for category in service_categories %}
                        <div class="service-category-card" style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; transition: all 0.3s ease; cursor: pointer;">
                            <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; margin: 0;">
                                <input 
                                    type="checkbox" 
                                    name="free_service_categories" 
                                    value="{{ category.id }}"
                                    id="category_{{ category.id }}"
                                    {% if category in user_obj.free_service_categories.all %}checked{% endif %}
                                    style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer;"
                                    onchange="updateCategoryCardStyle(this)"
                                >
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">
                                        {{ category.name }}
                                    </div>
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-tools"></i>
                                        {% with issues_count=category.issues.count %}
                                            {{ issues_count }} service{{ issues_count|pluralize }} available
                                        {% endwith %}
                                    </div>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
                        <i class="fas fa-exclamation-circle" style="font-size: 36px; margin-bottom: 10px; opacity: 0.3;"></i>
                        <div>No service categories available</div>
                        <div style="font-size: 12px; margin-top: 5px;">Please create service categories first</div>
                    </div>
                    {% endif %}
                    
                    <div style="margin-top: 20px; padding: 12px; background: rgba(96, 165, 250, 0.1); border-radius: 6px; border-left: 3px solid #60a5fa;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                            <i class="fas fa-lightbulb" style="color: #60a5fa;"></i>
                            <strong>Tip:</strong> Uncheck any category to make it a paid service for this AMC customer. Selected services will be completely free of charge.
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: end;">
                <a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back to Users
                </a>
                <button type="button" onclick="resetPassword()" class="btn btn-secondary">
                    <i class="fas fa-key"></i>
                    Reset Password
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Update User
                </button>
            </div>
        </form>
    </div>

    <!-- Sidebar -->
    <div>
        <!-- User Stats -->
        <div class="table-container" style="margin-bottom: 30px;">
            <div class="table-header">
                <h3 class="table-title">User Statistics</h3>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Member Since</span>
                        <strong>{{ user_obj.date_joined|date:"M d, Y" }}</strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Last Login</span>
                        <strong>
                            {% if user_obj.last_login %}
                                {{ user_obj.last_login|date:"M d, Y" }}
                            {% else %}
                                Never
                            {% endif %}
                        </strong>
                    </div>
                    
                    {% if user_obj.role == 'CUSTOMER' or user_obj.role == 'AMC' %}
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total Orders</span>
                        <strong>{{ user_obj.order_set.count }}</strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Service Requests</span>
                        <strong>{{ user_obj.servicerequest_set.count }}</strong>
                    </div>
                    {% endif %}
                    
                    {% if user_obj.role == 'TECHNICIAN' %}
                    <div style="display: flex; justify-content: space-between;">
                        <span>Assigned Orders</span>
                        <strong>{{ user_obj.assigned_orders.count }}</strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Assigned Services</span>
                        <strong>{{ user_obj.assigned_services.count }}</strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Average Rating</span>
                        <strong>
                            {% with ratings=user_obj.ratings_received.all %}
                                {% if ratings %}
                                    {% for rating in ratings|slice:":1" %}
                                        {{ rating.rating|default:"N/A" }}â˜…
                                    {% endfor %}
                                {% else %}
                                    N/A
                                {% endif %}
                            {% endwith %}
                        </strong>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- AMC Benefits Summary - NEW -->
        {% if user_obj.role == 'AMC' %}
        <div class="table-container" style="margin-bottom: 30px;">
            <div class="table-header">
                <h3 class="table-title">
                    <i class="fas fa-star"></i>
                    AMC Benefits
                </h3>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Free Services</span>
                        <strong style="color: #10b981; font-size: 18px;">
                            {{ user_obj.free_service_categories.count }}
                        </strong>
                    </div>
                    
                    {% if user_obj.free_service_categories.exists %}
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-top: 8px;">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Included Services:
                        </div>
                        {% for category in user_obj.free_service_categories.all %}
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <i class="fas fa-check-circle" style="color: #10b981; font-size: 12px;"></i>
                            <span style="font-size: 12px;">{{ category.name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-top: 8px;">
                        <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 20px; margin-bottom: 8px;"></i>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.6);">
                            No free services assigned yet
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="table-container" style="margin-bottom: 30px;">
            <div class="table-header">
                <h3 class="table-title">Quick Actions</h3>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    {% if user_obj.role == 'CUSTOMER' or user_obj.role == 'AMC' %}
                    <a href="#" onclick="viewUserOrders()" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                        <i class="fas fa-shopping-cart"></i>
                        View Orders
                    </a>
                    
                    <a href="#" onclick="viewUserServices()" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                        <i class="fas fa-tools"></i>
                        View Services
                    </a>
                    {% endif %}
                    
                    {% if user_obj.role == 'TECHNICIAN' %}
                    <a href="#" onclick="viewTechnicianJobs()" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                        <i class="fas fa-briefcase"></i>
                        View Assigned Jobs
                    </a>
                    
                    <a href="#" onclick="viewTechnicianRatings()" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                        <i class="fas fa-star"></i>
                        View Ratings
                    </a>
                    {% endif %}
                    
                    <button type="button" onclick="sendPasswordReset()" class="btn btn-secondary">
                        <i class="fas fa-envelope"></i>
                        Send Password Reset
                    </button>
                    
                    {% if not user_obj.is_superuser %}
                    <button type="button" onclick="deleteUser()" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                        Delete User
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- User Activity -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Recent Activity</h3>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Last Login: 
                        {% if user_obj.last_login %}
                            {{ user_obj.last_login|timesince }} ago
                        {% else %}
                            Never logged in
                        {% endif %}
                    </div>
                    
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Account Created: {{ user_obj.date_joined|timesince }} ago
                    </div>
                    
                    {% if user_obj.role == 'CUSTOMER' or user_obj.role == 'AMC' %}
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Last Order: 
                        {% if user_obj.order_set.exists %}
                            {{ user_obj.order_set.first.order_date|timesince }} ago
                        {% else %}
                            No orders yet
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    document.getElementById('userForm').addEventListener('submit', function(e) {
        const email = document.querySelector('input[name="email"]').value;
        const name = document.querySelector('input[name="name"]').value;
        
        if (!email || !name) {
            e.preventDefault();
            alert('Name and email are required');
            return;
        }
    });

    // Email validation
    document.querySelector('input[name="email"]').addEventListener('blur', function() {
        const email = this.value;
        if (email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                this.style.borderColor = '#ef4444';
            } else {
                this.style.borderColor = '';
            }
        }
    });

    // Phone number formatting
    document.querySelector('input[name="phone"]').addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 10) value = value.substr(0, 10);
        this.value = value;
    });

    // Show/hide AMC services section based on role
    document.getElementById('userRole').addEventListener('change', function() {
        const amcSection = document.getElementById('amcServicesSection');
        const originalRole = '{{ user_obj.role }}';
        
        if (this.value === 'AMC') {
            amcSection.style.display = 'block';
            
            // Show a helpful message if changing TO AMC
            if (originalRole !== 'AMC') {
                const info = document.createElement('div');
                info.className = 'role-change-info';
                info.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; font-size: 12px; color: #10b981; border-left: 3px solid #10b981;';
                info.innerHTML = '<i class="fas fa-info-circle"></i> You can now select free service categories for this AMC user below.';
                
                // Remove existing info
                const existingInfo = this.parentNode.querySelector('.role-change-info');
                if (existingInfo) existingInfo.remove();
                
                this.parentNode.appendChild(info);
            }
        } else {
            amcSection.style.display = 'none';
            
            // Show warning if changing FROM AMC
            if (originalRole === 'AMC') {
                if (confirm('Changing from AMC role will remove all free service benefits. Continue?')) {
                    // Uncheck all free service categories
                    document.querySelectorAll('input[name="free_service_categories"]').forEach(cb => {
                        cb.checked = false;
                    });
                } else {
                    // Revert to AMC
                    this.value = 'AMC';
                    amcSection.style.display = 'block';
                    return;
                }
            }
        }
        
        // General role change warning
        if (this.value !== originalRole) {
            const warning = document.createElement('div');
            warning.className = 'role-change-warning';
            warning.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 6px; font-size: 12px; color: #fbbf24; border-left: 3px solid #fbbf24;';
            warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Changing user role will affect their permissions and access level.';
            
            // Remove existing warning
            const existingWarning = this.parentNode.querySelector('.role-change-warning');
            if (existingWarning) existingWarning.remove();
            
            this.parentNode.appendChild(warning);
        }
    });

    // Update visual style of category cards when selected
    function updateCategoryCardStyle(checkbox) {
        const card = checkbox.closest('.service-category-card');
        if (checkbox.checked) {
            card.style.background = 'rgba(16, 185, 129, 0.15)';
            card.style.borderColor = '#10b981';
        } else {
            card.style.background = 'rgba(255,255,255,0.05)';
            card.style.borderColor = 'rgba(255,255,255,0.1)';
        }
    }

    // Initialize card styles on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('input[name="free_service_categories"]').forEach(checkbox => {
            updateCategoryCardStyle(checkbox);
        });
    });

    // Quick action functions
    function resetPassword() {
        if (confirm('Generate a new password for this user? They will need to use the new password to log in.')) {
            alert('Password reset email sent to user!');
        }
    }

    function sendPasswordReset() {
        if (confirm('Send password reset email to {{ user_obj.email }}?')) {
            alert('Password reset email sent successfully!');
        }
    }

    function deleteUser() {
        if (confirm('Are you sure you want to delete user "{{ user_obj.name }}"? This action cannot be undone.')) {
            if (confirm('This will permanently delete the user and all associated data. Continue?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "admin_panel:delete_user" user_obj.id %}';
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                form.appendChild(csrfInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    }

    function viewUserOrders() {
        window.open('{% url "admin_panel:orders" %}?search={{ user_obj.email }}', '_blank');
    }

    function viewUserServices() {
        window.open('{% url "admin_panel:services" %}?search={{ user_obj.email }}', '_blank');
    }

    function viewTechnicianJobs() {
        window.open('{% url "admin_panel:orders" %}?technician={{ user_obj.id }}', '_blank');
    }

    function viewTechnicianRatings() {
        alert('Technician ratings view coming soon!');
    }
</script>

<style>
    .service-category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        border-color: rgba(255,255,255,0.2) !important;
    }
    
    .service-category-card input[type="checkbox"]:checked {
        accent-color: #10b981;
    }
</style>
{% endblock %}